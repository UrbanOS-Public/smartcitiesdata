properties([
    parameters([
        credentials(
            credentialType: 'com.microsoft.jenkins.kubernetes.credentials.KubeconfigCredentials', 
            defaultValue: 'kubeconfig-dev', 
            description: 'Environment to deploy to',
            name: 'kubernetesCreds', 
            required: true
        ),
        text(
            name: 'tag',
            description: "The Docker image ID to deploy",
            required: true
        )        
    ])
])

node('master') {
    ansiColor('xterm') {

        stage('Checkout') {
            checkout scm
        }

        stage('Deploy') {
            sh("sed -i 's/%VERSION%/${params.tag}/' k8s/1-deployment.yaml")
            kubernetesDeploy(kubeconfigId: "${params.kubernetesCreds}",
                    configs: 'k8s/*',
                    secretName: 'regcred',
                    dockerCredentials: [
                            [credentialsId: 'ecr:us-east-2:aws_jenkins_user', url: 'https://199837183662.dkr.ecr.us-east-2.amazonaws.com'],
                    ]
            )
        }
    }
}
